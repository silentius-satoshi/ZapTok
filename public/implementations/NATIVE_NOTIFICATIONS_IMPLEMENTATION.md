# Native Notifications Implementation for PWA

## Overview

This document explains how native push notifications work in ZapTok PWA after switching to custom service worker with `injectManifest` mode.

## Problem

Initially, notifications weren't showing in PWA mode because:

1. **Auto-generated Service Worker**: VitePWA was using `generateSW` mode which created its own service worker
2. **Missing Message Handler**: Our custom notification handling code in `public/sw.js` wasn't being used in production
3. **Client-side Notification API**: Trying to use `new Notification()` directly from client doesn't work in PWA

## Solution

### 1. Switch to InjectManifest Mode

Changed VitePWA configuration from `generateSW` to `injectManifest`:

```typescript
// vite.config.ts
VitePWA({
  strategies: 'injectManifest',
  srcDir: 'public',
  filename: 'sw.js',
  registerType: 'autoUpdate',
  injectManifest: {
    maximumFileSizeToCacheInBytes: 5 * 1024 * 1024, // 5 MB
  },
  // ... rest of config
})
```

**Why?**
- `generateSW`: Workbox auto-generates a service worker (doesn't include our custom code)
- `injectManifest`: Uses our custom `public/sw.js` with full control over notification handling

### 2. Add Service Worker Message Handler

Added message handler in `public/sw.js` to receive notification requests from client:

```javascript
// Listen for messages from client
self.addEventListener('message', async (event) => {
  console.log('[SW] üîî Message received:', event.data);

  if (event.data && event.data.type === 'show-notification') {
    const payload = event.data.payload;
    console.log('[SW] üì¨ Notification payload:', payload);

    try {
      console.log('[SW] üì¢ About to show notification:', payload.title);
      
      await self.registration.showNotification(payload.title, {
        body: payload.body,
        icon: payload.icon || '/images/ZapTok-v3.png',
        badge: payload.badge || '/images/ZapTok-v3.png',
        data: payload.data,
        tag: payload.tag,
        requireInteraction: true,
        actions: payload.actions || [],
      });

      console.log('[SW] ‚úÖ Notification shown successfully');
    } catch (error) {
      console.error('[SW] ‚ùå Failed to show notification:', error);
    }
  } else {
    console.log('[SW] ‚ö†Ô∏è Unrecognized message type:', event.data?.type);
  }
});
```

### 3. Update Client-Side Notification Function

Modified `showLocalNotification` in `src/hooks/usePushNotifications.ts` to send messages to service worker:

```typescript
export function showLocalNotification(payload: NotificationPayload, toast?: ReturnType<typeof useToast>['toast']): void {
  // Check if running in PWA/standalone mode
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                      (window.navigator as any).standalone === true ||
                      document.referrer.includes('android-app://');

  // If not in PWA mode and toast is available, use toast instead
  if (!isStandalone && toast) {
    toast({
      title: payload.title,
      description: payload.body,
      duration: 5000,
    });
    return;
  }

  // PWA mode: send message to service worker
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'show-notification',
      payload: {
        title: payload.title,
        body: payload.body,
        icon: payload.icon,
        badge: payload.badge,
        data: payload.data,
        tag: payload.type,
        actions: payload.actions,
      }
    });
  } else {
    // Fallback to toast if no service worker
    if (toast) {
      toast({
        title: payload.title,
        description: payload.body,
        duration: 5000,
      });
    }
  }
}
```

### 4. Add Workbox Precache Manifest

Added Workbox precaching injection point to `public/sw.js`:

```javascript
import { precacheAndRoute } from 'workbox-precaching';

// Precache all assets generated by Vite
precacheAndRoute(self.__WB_MANIFEST);
```

This allows Workbox to inject the list of files to precache while keeping our custom notification logic.

## How It Works

### Flow Diagram

```
User Event (Zap received)
        ‚Üì
useEventNotifications.notifyZap()
        ‚Üì
showLocalNotification()
        ‚Üì
Check: PWA mode?
        ‚Üì
    Yes ‚Üí Send message to Service Worker
        ‚Üì
Service Worker receives 'show-notification' message
        ‚Üì
self.registration.showNotification()
        ‚Üì
Native system notification appears!
```

### Detection Logic

```typescript
const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                    (window.navigator as any).standalone === true ||
                    document.referrer.includes('android-app://');
```

**Detection Methods:**
1. `display-mode: standalone` - Standard PWA detection
2. `navigator.standalone` - iOS Safari PWA detection  
3. `android-app://` in referrer - Android TWA detection

## Testing

### Test in PWA Mode

1. **Install the PWA** (if not already installed)
2. **Open DevTools** ‚Üí Application ‚Üí Service Workers
3. **Run test in console:**

```javascript
if (navigator.serviceWorker.controller) {
  navigator.serviceWorker.controller.postMessage({
    type: 'show-notification',
    payload: {
      title: '‚ö° Test Zap',
      body: 'Received 1000 sats!',
      icon: '/images/ZapTok-v3.png',
      badge: '/images/ZapTok-v3.png',
      data: { url: '/wallet' },
      tag: 'test-zap',
    }
  });
  console.log('Notification message sent to service worker');
} else {
  console.error('No service worker controller found');
}
```

4. **Check Service Worker console** for logs:
   - `[SW] üîî Message received:`
   - `[SW] üì¨ Notification payload:`
   - `[SW] üì¢ About to show notification:`
   - `[SW] ‚úÖ Notification shown successfully`

5. **Verify native notification** appears in system notification center

### Test in Browser Mode

1. **Open ZapTok in regular browser tab** (not PWA)
2. **Trigger a notification event** (zap, comment, etc.)
3. **Verify toast notification** appears inside the app (not native)

## Benefits

‚úÖ **Native Notifications in PWA**: Full system-level notifications when installed
‚úÖ **Toast Fallback**: Graceful degradation to in-app toasts for browser mode
‚úÖ **No Permission Barriers**: Works immediately without prompting
‚úÖ **Custom Control**: Full control over service worker behavior
‚úÖ **Workbox Integration**: Still get PWA precaching and offline support
‚úÖ **Progressive Enhancement**: Better experience for installed users

## Configuration Files

### vite.config.ts
- Switched to `injectManifest` strategy
- Set `srcDir: 'public'` to use custom service worker
- Increased `maximumFileSizeToCacheInBytes` to 5 MB

### public/sw.js
- Custom service worker with notification message handler
- Workbox precaching integration
- Push notification handlers
- Click handlers for notification actions

### src/hooks/usePushNotifications.ts
- Client-side notification logic
- PWA vs browser mode detection
- Service worker message posting
- Toast fallback system

## Debugging

See [`NATIVE_NOTIFICATION_DEBUGGING.md`](./NATIVE_NOTIFICATION_DEBUGGING.md) for comprehensive debugging guide.

## Common Issues

### Issue: Notifications not showing in PWA

**Check:**
1. Service worker is active: DevTools ‚Üí Application ‚Üí Service Workers
2. `navigator.serviceWorker.controller` exists
3. Service worker console shows message received
4. Notification permission granted: `Notification.permission === 'granted'`

### Issue: Build fails with file size error

**Solution:** Increase `maximumFileSizeToCacheInBytes` in vite.config.ts

### Issue: Service worker not updating

**Solution:**
1. Unregister old service worker
2. Hard refresh (Cmd/Ctrl + Shift + R)
3. Check "Update on reload" in DevTools

## Future Enhancements

- [ ] Badge counter on app icon
- [ ] Rich notification content (images, actions)
- [ ] Notification grouping
- [ ] Custom notification sounds
- [ ] Action buttons (Reply, View, Dismiss)
- [ ] Silent background notifications
- [ ] Notification history view

## References

- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Notifications API](https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API)
- [VitePWA InjectManifest](https://vite-pwa-org.netlify.app/guide/inject-manifest.html)
- [Workbox](https://developers.google.com/web/tools/workbox)

---

*Last updated: October 2025*
