NIP-71
======

Video Events
-----------

`draft` `optional`

This NIP defines video events representing a video by its cryptographic hash and list of relay URIs at which the video file is hosted.

## Video Events

A video event is a `parameterized replaceable event` with `kind 34235`. The `.content` of these events is a summary or description of the video.

The list of tags are as follows:
* `d` (required) universally unique identifier. Generated by the client creating the video event.
* `url` (required) the url to the video file
* `m` a string indicating the data type of the file. The MIME type of the file. If not provided, relays SHOULD guess the MIME type from the file extension.
* `title` (optional) title of the video
* `published_at` (optional) unix timestamp (stringified) of the date the video was published
* `x` (optional) SHA-256 hex hash of the file for verification purposes
* `size` (optional) size of the file in bytes (stringified)
* `dim` (optional) size of the video file in pixels in the form `<width>x<height>`
* `duration` (optional) video duration in seconds (stringified)
* `magnet` (optional) URI to magnet file
* `i` (optional) torrent infohash
* `text-track` (optional, repeated) link to WebVTT file for video, type of supplementary file indicate the role of the text track
* `thumb` (optional) link to thumbnail image
* `image` (optional) link to preview image
* `content-warning` (optional) warning about content of NSFW video
* `alt` (optional) description for accessibility
* `segment` (optional, repeated) start timestamp in format `HH:MM:SS-HH:MM:SS` (end timestamp is optional), optionally followed by a label for the segment
* `t` (optional, repeated) hashtag to categorize video
* `p` (optional, repeated) 32-bytes hex pubkey of a participant in the video, can optionally be followed by a relay URL and a petname
* `r` (optional, repeated) references to websites, articles, etc. related to the video (NIP-24)

```json
{
  "id": <32-bytes lowercase hex-encoded SHA-256 of the serialized event data>,
  "pubkey": <32-bytes lowercase hex-encoded public key of the event creator>,
  "created_at": <Unix timestamp in seconds>,
  "kind": 34235,
  "content": "Video of my adorable pet",
  "tags": [
    ["d", "unique-id-123"],
    ["url", "https://example.com/video.mp4"],
    ["m", "video/mp4"],
    ["title", "My Pet Video"],
    ["published_at", "1672531200"],
    ["x", "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"],
    ["size", "15032385"],
    ["dim", "1920x1080"],
    ["duration", "120"],
    ["thumb", "https://example.com/thumb.jpg"],
    ["t", "pets"],
    ["t", "video"],
    ["alt", "A video showing my pet playing in the garden"]
  ],
  "sig": <64-bytes lowercase hex of the signature of the SHA-256 hash of the serialized event data>
}
```

## Video View Event

A video view event is a `regular event` with `kind 34236`. This event serves as a way to signal user engagement with video content for metrics and social proof.

The list of tags are as follows:
* `a` (required) reference to the video event being viewed (`kind:pubkey:d-tag`)
* `d` (optional) duration watched in seconds (stringified)

```json
{
  "id": <32-bytes lowercase hex-encoded SHA-256 of the serialized event data>,
  "pubkey": <32-bytes lowercase hex-encoded public key of the event creator>,
  "created_at": <Unix timestamp in seconds>,
  "kind": 34236,
  "content": "",
  "tags": [
    ["a", "34235:authorpubkey:unique-id-123"],
    ["d", "45"]
  ],
  "sig": <64-bytes lowercase hex of the signature of the SHA-256 hash of the serialized event data>
}
```

## Client Behavior

### Publishing Videos
When publishing videos, clients:
1. Upload video file to video hosting service (Blossom, etc.)
2. Generate SHA-256 hash of video file for verification
3. Create video event (kind 34235) with metadata
4. Include all relevant tags for discoverability
5. Publish event to relays

### Displaying Videos
When displaying videos, clients:
1. Query for video events (kind 34235)
2. Validate video URLs and hashes when available
3. Display video with metadata (title, description, etc.)
4. Show engagement metrics (views, reactions, zaps)
5. Handle fallback URLs for video hosting

### Recording Views
When users view videos, clients:
1. Track viewing duration
2. Create view event (kind 34236) after meaningful engagement
3. Reference the original video via `a` tag
4. Include duration watched in `d` tag

## Technical Implementation

### Video Hosting
Videos can be hosted on:
- **Blossom servers**: Decentralized file hosting for Nostr
- **IPFS**: Content-addressable storage
- **Traditional CDNs**: Centralized but widely supported
- **BitTorrent**: Peer-to-peer distribution via magnet links

### File Verification
When `x` tag is present:
1. Download video file
2. Compute SHA-256 hash
3. Compare with hash in `x` tag
4. Display verification status to users

### Multiple URLs
Events may contain multiple `url` tags for:
- **Redundancy**: Multiple mirrors of the same content
- **Quality levels**: Different resolutions/bitrates  
- **Formats**: Different video codecs/containers
- **CDN distribution**: Regional optimization

### Privacy Considerations
View events (kind 34236):
- Reveal user engagement patterns
- May impact privacy if published
- Clients should allow users to opt-out
- Consider aggregated/anonymized metrics

## Advanced Features

### Segments and Chapters
Use `segment` tags for:
```
["segment", "00:00-02:30", "Introduction"]
["segment", "02:30-15:45", "Main Content"] 
["segment", "15:45-17:00", "Conclusion"]
```

### Text Tracks and Subtitles
Use `text-track` tags for accessibility:
```
["text-track", "https://example.com/subtitles-en.vtt", "subtitles", "en"]
["text-track", "https://example.com/captions-en.vtt", "captions", "en"]
```

### Participants and Credits
Use `p` tags to credit participants:
```
["p", "pubkey1", "wss://relay.com", "Director"]
["p", "pubkey2", "wss://relay.com", "Actor"]
```

## Relay Considerations

### Storage Requirements
- Video events are replaceable (kind 34235)
- Only latest version per author+d-tag is stored
- View events (kind 34236) are regular events
- Consider storage limits for large video metadata

### Indexing and Search
- Index `t` tags for content discovery
- Index `published_at` for chronological ordering
- Consider full-text search on titles/descriptions
- Index participant `p` tags for creator discovery

## Content Moderation

### Content Warnings
Use `content-warning` tag for NSFW content:
```json
["content-warning", "Contains adult content"]
```

### Reporting and Filtering
- Clients can implement content filtering
- Use NIP-56 reporting events for inappropriate content
- Relays may implement content policies
- Consider decentralized moderation systems

## Economic Considerations

### Monetization
- Lightning zaps for video support (NIP-57)
- Paid content via Lightning paywalls
- Creator tip functionality
- Subscription-based access models

### Hosting Costs
- Video hosting requires significant bandwidth
- Consider economic incentives for hosts
- Implement efficient caching strategies
- Use CDNs for global distribution

## Example Implementation

```typescript
// Create video event
interface VideoEventTags {
  d: string;           // unique identifier
  url: string[];       // video URLs (can be multiple)
  m?: string;          // MIME type
  title?: string;      // video title
  published_at?: string; // unix timestamp
  x?: string;          // SHA-256 hash
  size?: string;       // file size in bytes
  dim?: string;        // dimensions (WxH)
  duration?: string;   // duration in seconds
  thumb?: string;      // thumbnail URL
  t?: string[];        // hashtags
  alt?: string;        // accessibility description
}

function createVideoEvent(tags: VideoEventTags, content: string): NostrEvent {
  const eventTags: string[][] = [
    ['d', tags.d],
    ...tags.url.map(url => ['url', url]),
  ];
  
  if (tags.m) eventTags.push(['m', tags.m]);
  if (tags.title) eventTags.push(['title', tags.title]);
  if (tags.published_at) eventTags.push(['published_at', tags.published_at]);
  if (tags.x) eventTags.push(['x', tags.x]);
  if (tags.size) eventTags.push(['size', tags.size]);
  if (tags.dim) eventTags.push(['dim', tags.dim]);
  if (tags.duration) eventTags.push(['duration', tags.duration]);
  if (tags.thumb) eventTags.push(['thumb', tags.thumb]);
  if (tags.alt) eventTags.push(['alt', tags.alt]);
  
  // Add hashtags
  tags.t?.forEach(tag => eventTags.push(['t', tag]));
  
  return {
    kind: 34235,
    content,
    tags: eventTags,
    created_at: Math.floor(Date.now() / 1000),
    // ... other required fields
  };
}

// Record video view
function createViewEvent(videoRef: string, durationWatched: number): NostrEvent {
  return {
    kind: 34236,
    content: '',
    tags: [
      ['a', videoRef], // kind:pubkey:d-tag format
      ['d', durationWatched.toString()]
    ],
    created_at: Math.floor(Date.now() / 1000),
    // ... other required fields
  };
}
```

## Related NIPs

- **NIP-01**: Basic protocol and event structure
- **NIP-94**: File metadata events (general file handling)
- **NIP-57**: Lightning Zaps (video monetization)
- **NIP-56**: Reporting (content moderation)
- **NIP-24**: Extra metadata fields and tags
- **NIP-94**: File metadata (alternative approach)

## Status

**Implementation Status in ZapTok**: ✅ Core Feature

**Details**:
- ✅ Video event creation (kind 34235)
- ✅ Video metadata handling
- ✅ Multiple URL support (fallback system)
- ✅ Blossom server integration
- ✅ Video display and playback
- ✅ Hashtag support (`t` tags)
- ✅ Basic video metrics
- ❌ View events (kind 34236) - not implemented
- ❌ Advanced features (segments, text tracks)
- ❌ File verification (SHA-256 checking)
